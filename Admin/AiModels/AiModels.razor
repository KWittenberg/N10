@page "/admin/aimodels"
@attribute [Authorize(Roles = "Admin")]

@inject AiService AiService

<title>@Title</title>
<_PageHeader Title="@Title" />

@if (Entities is null)
{
    <_Loading />
}
else
{
    <div class="mt-3 @App?.GetContentClass()">
        <div class="quickgrid-wrapper table-responsive">
            <QuickGrid Items="Entities.AsQueryable()" Class="p-sm table table-hover align-middle">

                <PropertyColumn Property="x => x.Name" Title="Model Name" Sortable="true" Class="fw-bold text-light" />

                <TemplateColumn Title="Status" Align="Align.Center">
                    @if (context.IsChecking)
                    {
                        <div class="spinner-border spinner-border-sm text-warning" role="status"></div>
                    }
                    else if (context.IsAvailable)
                    {
                        <i class="bi bi-check-circle-fill text-success fs-5"></i>
                    }
                    else
                    {
                        <i class="bi bi-x-circle-fill text-danger fs-5"></i>
                    }
                </TemplateColumn>

                <PropertyColumn Property="x => x.StatusMessage" Title="Message" Class="small text-muted" />
            </QuickGrid>
        </div>
    </div>
}

@code {
    [CascadingParameter] AppState? App { get; set; }

    List<AiModelStatus> Entities = new();

    const string Title = "AiModels";

    protected override async Task OnInitializedAsync() => await LoadAsync();

    async Task LoadAsync()
    {
        foreach (var name in ModelsToCheck)
        {
            Entities.Add(new AiModelStatus { Name = name });
        }

        _ = RunChecks();
    }

    async Task RunChecks()
    {
        // Vrtimo 5 provjera paralelno da bude brzo
        var parallelOptions = new ParallelOptions { MaxDegreeOfParallelism = 5 };

        await Parallel.ForEachAsync(Entities, parallelOptions, async (item, ct) =>
        {
            // Pozivamo servis
            item.StatusMessage = "Checking...";
            await InvokeAsync(StateHasChanged); // Osvježi da se vidi spinner

            var result = await AiService.CheckModelAvailabilityAsync(item.Name);

            // Ažuriramo rezultat
            item.IsAvailable = result.IsAvailable;
            item.StatusMessage = result.Message;
            item.IsChecking = false;

            // Osvježi UI za ovaj redak
            await InvokeAsync(StateHasChanged);
        });
    }


    List<string> ModelsToCheck =
    [
        "models/gemini-1.5-flash",
        "models/embedding-gecko-001",
        "models/gemini-2.5-flash",
        "models/gemini-2.5-pro",
        "models/gemini-2.0-flash-exp",
        "models/gemini-2.0-flash",
        "models/gemini-2.0-flash-001",
        "models/gemini-2.0-flash-lite-001",
        "models/gemini-2.0-flash-lite",
        "models/gemini-2.0-flash-lite-preview-02-05",
        "models/gemini-2.0-flash-lite-preview",
        "models/gemini-exp-1206",
        "models/gemini-2.5-flash-preview-tts",
        "models/gemini-2.5-pro-preview-tts",
        "models/gemma-3-1b-it",
        "models/gemma-3-4b-it",
        "models/gemma-3-12b-it",
        "models/gemma-3-27b-it",
        "models/gemma-3n-e4b-it",
        "models/gemma-3n-e2b-it",
        "models/gemini-flash-latest",
        "models/gemini-flash-lite-latest",
        "models/gemini-pro-latest",
        "models/gemini-2.5-flash-lite",
        "models/gemini-2.5-flash-image-preview",
        "models/gemini-2.5-flash-image",
        "models/gemini-2.5-flash-preview-09-2025",
        "models/gemini-2.5-flash-lite-preview-09-2025",
        "models/gemini-3-pro-preview",
        "models/gemini-3-flash-preview",
        "models/gemini-3-pro-image-preview",
        "models/nano-banana-pro-preview",
        "models/gemini-robotics-er-1.5-preview",
        "models/gemini-2.5-computer-use-preview-10-2025",
        "models/deep-research-pro-preview-12-2025",
        "models/embedding-001",
        "models/text-embedding-004",
        "models/gemini-embedding-exp-03-07",
        "models/gemini-embedding-exp",
        "models/gemini-embedding-001",
        "models/aqa",
        "models/imagen-4.0-generate-preview-06-06",
        "models/imagen-4.0-ultra-generate-preview-06-06",
        "models/imagen-4.0-generate-001",
        "models/imagen-4.0-ultra-generate-001",
        "models/imagen-4.0-fast-generate-001",
        "models/veo-2.0-generate-001",
        "models/veo-3.0-generate-001",
        "models/veo-3.0-fast-generate-001",
        "models/veo-3.1-generate-preview",
        "models/veo-3.1-fast-generate-preview",
        "models/gemini-2.5-flash-native-audio-latest",
        "models/gemini-2.5-flash-native-audio-preview-09-2025",
        "models/gemini-2.5-flash-native-audio-preview-12-2025"
    ];

    public class AiModelStatus
    {
        public string Name { get; set; } = string.Empty;
        public bool IsAvailable { get; set; }
        public string StatusMessage { get; set; } = "Checking...";
        public bool IsChecking { get; set; } = true;
    }
}