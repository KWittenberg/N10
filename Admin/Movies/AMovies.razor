@page "/admin/movies"
@attribute [Authorize(Roles = "Admin")]

@inject ApplicationDbContext Context
@inject MovieService MovieService
@inject ITmdbService TmdbService

<title>@Title</title>

<_PageHeader Title="@Title" />


<!-- Scan - Populate - Search -->
@if (Entity is null)
{
    <div class="mt-4 p-2 @App?.GetContentClass()">
        <div class="row align-items-center">
            <div class="col-12 col-md-6">
                <button type="button" class="btn btn-primary rounded-pill btn-sm" @onclick="ScanAsync">Scan</button>
                @if (Entities is not null && Entities.Any())
                {
                    <button type="button" class="ms-2 btn btn-primary rounded-pill btn-sm" @onclick="PopulateFromTmdb">Populate From Tmdb</button>
                }
            </div>

            <div class="col-12 col-md-6">
                <EditForm Enhance Model=@SearchTmdb OnValidSubmit=@HandleValidSubmit>
                    <div class="input-group">
                        <InputText class="form-control" @bind-Value="SearchTmdb" placeholder=" search tmdb.." required />
                        <button class="btn btn-primary" type="submit">Search</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@if(Entity is not null)
{
    <_Form Entity="Entity" OnBack="() => Entity = null"/>
}

@if (IsProcessing)
{
    <_Loading Title="Please Scan to populate the database!"
              Subtitle="@($"Scaning Folder: {ScanPath}")"
              ButtonText="Scan" OnClick="ScanAsync" />
}
else
{
    @if (TmdbSearch is null && TmdbDetails is null && Entity is null)
    {
        <div class="mt-3 @App?.GetContentClass()">
            @if (Movies is not null)
            {
                <_Table Entities="Movies.Select(s => s.ToMovieEntity()).AsQueryable()" EntityName="Scan" OnTmdbSearch="HandleSearch" OnLoadEntities="RefreshEntitiesAsync" OnEdit="AddEdit" />
            }
            @if (Entities is not null)
            {
                <_Table Entities="Entities" EntityName="@Title" OnLoadEntities="RefreshEntitiesAsync" OnEdit="AddEdit" OnPopulate="PopulateFromTmdbById" />
            }
        </div>
    }
}

<!-- SearchCard -->
@if (TmdbSearch is not null)
{
    <div class="mt-5 @App?.GetContentClass()">
        <div class="m-3 d-flex justify-content-start align-items-center" style="cursor: pointer;" @onclick="() => TmdbSearch = null">
            <button type="button" class="btn-close me-2"></button>Close Search
        </div>

        @foreach (var movie in TmdbSearch.Results)
        {
            <_SearchCard Entity="movie" />
        }
    </div>
}

<!-- DetailsCard -->
@if (TmdbDetails is not null)
{
    <div class="mt-5 @App?.GetContentClass()">
        <div class="m-3 d-flex justify-content-start align-items-center" style="cursor: pointer;" @onclick="() => TmdbDetails = null">
            <button type="button" class="btn-close me-2"></button>Close Details
        </div>
        <_DetailsCard Entity="TmdbDetails" />
    </div>
}



@code {
    [CascadingParameter] AppState? App { get; set; }

    List<ScanMovieModel>? Movies;
    IQueryable<Movie>? Entities;
    Movie? Entity;
    string? Search;

    string SearchTmdb = string.Empty;
    TmdbSearchList? TmdbSearch;
    TmdbDetails? TmdbDetails;

    const string Title = "Movies";
    bool IsProcessing { get; set; } = true;
    bool IsEditing { get; set; } = false;

    string ScanPath => Globals.X265Path;



    protected override async Task OnInitializedAsync() => await RefreshEntitiesAsync();

    async Task RefreshEntitiesAsync()
    {
        // await using var db = await context.CreateDbContextAsync();

        Entities = Context.Movies.AsNoTracking().OrderBy(x => x.SortTitle).AsQueryable();
        if (!Entities.Any())
        {
            await App!.ShowToast($"{Title} Not Found!", "error");
            Entities = null;
            return;
        }

        IsProcessing = false;
        // StateHasChanged();
    }

    async Task HandleValidSubmit()
    {
        ArgumentNullException.ThrowIfNull(SearchTmdb);

        TmdbSearch = await TmdbService.SearchMoviesAsync(SearchTmdb);

        SearchTmdb = string.Empty;
        StateHasChanged();
    }

    async Task HandleSearch((int? tmdbId, string search, int? year) data)
    {
        if (data.tmdbId.HasValue) TmdbDetails = await TmdbService.GetMovieByIdAsync(data.tmdbId.Value);
        else TmdbSearch = await TmdbService.SearchMoviesAsync(data.search, data.year.ToString());

        SearchTmdb = string.Empty;
        StateHasChanged();
    }

    async Task AddEdit(Movie? input)
    {
        Entity = input;
        await Task.CompletedTask;
    }

    async Task ScanAsync()
    {
        await App!.ShowToast($"Scaning For New Movies!", "success");
        var scannedMovies = await MovieService.GetAllMoviesInFolderAsync(ScanPath);
        if (scannedMovies.Count > 0)
        {
            if (Entities is not null && await Entities.AnyAsync())
            {
                var existingFileNames = await Entities.Select(m => m.FileName.ToLower()).ToHashSetAsync();
                Movies = scannedMovies.Where(m => !existingFileNames.Contains(m.FileName.ToLowerInvariant())).ToList();
            }
            else Movies = scannedMovies;
            await App!.ShowToast($"Found: {Movies.Count} movies!", "success");
            IsProcessing = false;
        }
        else await App!.ShowToast($"{Title} Not Found!", "error");
    }

    async Task PopulateFromTmdb()
    {
        await App!.ShowToast($"Start Populate From Tmdb!", "success");
        await MovieService.PopulateFromTmdbAsync();
        await RefreshEntitiesAsync();
        await App!.ShowToast($"Finish and Add Details in Database!", "success");
    }

    async Task PopulateFromTmdbById(Guid id)
    {
        var result = await MovieService.PopulateFromTmdbByIdAsync(id);
        if (result.Success)
        {
            await App!.ShowToast($"{result.Message}", "success");
            await RefreshEntitiesAsync();
        }
        else await App!.ShowToast($"{result.Message}", "error");
    }
}
