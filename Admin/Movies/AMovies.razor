@page "/admin/movies"
@attribute [Authorize(Roles = "Admin")]

@inject IDbContextFactory<ApplicationDbContext> context
@inject ApplicationDbContext db
@inject IMovieRepository Repository
@inject ITmdbService TmdbService

<title>@Title</title>

<_PageHeader Title="@Title" />

@if (IsProcessing || Entities is null)
{
    @if (Entities is null)
    {
        <div class="@App?.GetContentClass() d-flex justify-content-center align-content-center">
            <button type="button" class="btn btn-primary rounded-pill btn-sm" @onclick="ScanNew">Scan New</button>
        </div>
    }
    <_Loading />
}
else
{
    <div class="mb-5 @App?.GetContentClass()">

        <!-- ScanNew - PopulateFromTmdb - Search Tmdb -->
        @if (SearchTmdb is not null)
        {
            <div class="mt-3 row align-items-center">
                <div class="col-12 col-md-6">
                    <button type="button" class="btn btn-primary rounded-pill btn-sm" @onclick="ScanNew">Scan New</button>
                    <button type="button" class="btn btn-primary rounded-pill btn-sm" @onclick="PopulateFromTmdb">Populate From Tmdb</button>
                </div>

                <div class="col-12 col-md-6">
                    <EditForm Enhance Model=@SearchTmdb OnValidSubmit=@HandleValidSubmit>
                        <div class="input-group">
                            <InputText class="form-control" @bind-Value="SearchTmdb" placeholder=" search tmdb.." required />
                            <button class="btn btn-primary" type="submit">Search</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        }

        <!-- Table -->
        @if (TmdbSearch is null && TmdbDetails is null)
        {
            <_Table Entities="Entities" EntityName="Title" OnLoadEntities="RefreshEntitiesAsync" OnEdit="AddEdit" />
        }
        <!-- SearchCard -->
        @if (TmdbSearch is not null)
        {
            <div class="mt-5">
                <div class="m-3 d-flex justify-content-start align-items-center" style="cursor: pointer;" @onclick="() => TmdbSearch = null">
                    <button type="button" class="btn-close me-2"></button>Close Search
                </div>

                @foreach (var movie in TmdbSearch.Results)
                {
                    <_SearchCard Entity="movie" />
                }
            </div>
        }

        <!-- DetailsCard -->
        @if (TmdbDetails is not null)
        {
            <div class="mt-5">
                <div class="m-3 d-flex justify-content-start align-items-center" style="cursor: pointer;" @onclick="() => TmdbDetails = null">
                    <button type="button" class="btn-close me-2"></button>Close Details
                </div>
                <_DetailsCard Entity="TmdbDetails" />
            </div>
        }
    </div>
}

@code {
    [CascadingParameter] AppState? App { get; set; }

    List<Movie>? Movies;
    IQueryable<Movie>? Entities;
    string? Search;

    string SearchTmdb = string.Empty;
    TmdbSearchList? TmdbSearch;
    TmdbDetails? TmdbDetails;

    const string Title = "Movies";
    bool IsProcessing { get; set; } = true;


    protected override async Task OnInitializedAsync() => await RefreshEntitiesAsync();

    async Task RefreshEntitiesAsync()
    {
        // await using var db = await context.CreateDbContextAsync();

        Entities = db.Movies.AsNoTracking().OrderBy(x => x.SortTitle).AsQueryable();
        if (!Entities.Any())
        {
            await App!.ShowToast($"{Title} Not Found!", "error");
            return;
        }

        IsProcessing = false;
        // StateHasChanged();
    }

    async Task HandleValidSubmit()
    {
        ArgumentNullException.ThrowIfNull(SearchTmdb);

        TmdbSearch = await TmdbService.SearchMoviesAsync(SearchTmdb);

        SearchTmdb = string.Empty;
        StateHasChanged();
    }

    async Task AddEdit(Movie? input)
    {
        // Look in the Users.razor for reference.
        // Input = input;
        // IsEditing = true;
        // await Task.CompletedTask;
    }



    async Task ScanNew()
    {
        await App!.ShowToast($"START - Scan For New Movies!", "success");
        await Repository.SyncParsedMoviesAsync(Globals.X265Path);
        await RefreshEntitiesAsync();
        await App!.ShowToast($"END - Scan Finish and Add in Database!", "success");
    }

    async Task PopulateFromTmdb()
    {
        await App!.ShowToast($"Start Populate From Tmdb!", "success");
        await Repository.PopulateFromTmdbAsync();
        await RefreshEntitiesAsync();
        await App!.ShowToast($"Finish and Add Details in Database!", "success");
    }

    async Task PopulateFromTmdb(Guid id)
    {
        await App!.ShowToast($"Start Populate From Tmdb!", "success");
        await Repository.PopulateFromTmdbByIdAsync(id);
        await RefreshEntitiesAsync();
        await App!.ShowToast($"Finish and Add Details in Database!", "success");
    }

    #region ---> DELETE
    void ShowDelete(Movie input)
    {
        App?.ShowDeleteConfirmation(input.Title, input.Id.ToString(), EventCallback.Factory.Create(this, () => ConfirmDelete(input.Id)));
    }

    async Task ConfirmDelete(Guid id)
    {
        @* var result = await Repository.DeleteAsync(id);
        if (result.Success) await RefreshEntitiesAsync();

        await App!.ShowToast(result.Message, result.Success ? "success" : "error"); *@
    }
    #endregion
}
