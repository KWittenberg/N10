@page "/admin/movies"
@using N10.Entities
@using System.ComponentModel.DataAnnotations;
@attribute [Authorize(Roles = "Admin")]
@inject IMovieService Service
@inject ITmdbService TmdbService

<title>@Title</title>

<_PageHeader Title="@Title" />

@if (IsProcessing || Entities is null)
{
    <_Loading />
}
else
{
    <div class="@App?.GetContentClass()">

        @if (SearchTerm is not null)
        {
            <EditForm Enhance Model=@SearchTerm OnValidSubmit=@HandleValidSubmit>
                <div class="mt-5 row justify-content-end">
                    <div class="col-12 col-md-6">
                        <div class="input-group">
                            <InputText class="form-control" @bind-Value="SearchTerm" placeholder="find movie.." required />
                            <button class="btn btn-primary" type="submit">Search</button>
                        </div>
                    </div>
                </div>
            </EditForm>
        }

        @if (TmdbSearch is null)
        {
            <div class="quickgrid-wrapper-sm table-responsive">
                <QuickGrid Class="table table-striped table-hover align-middle" Items="Entities.AsQueryable()" Pagination="PaginationState">
                    <TemplateColumn Title="Title" Align="Align.Start">
                        @*<a class="me-2" href="admin/movie/@Uri.EscapeDataString(context.Title)/@(context.Year)">@context.Title</a>*@
                        <a class="ms-4 text-decoration-none text-white" style="cursor: pointer;"
                           @onclick="() => HandleClick(context.Title, context.Year)">@context.Title</a>
                    </TemplateColumn>

                    <PropertyColumn Property="x => x.Year" Title="Year" Align="Align.Center" Sortable="true" />
                    <PropertyColumn Property="x => x.VersionType" Title="VersionType" Align="Align.Center" Sortable="true" />
                    <PropertyColumn Property="x => x.ResolutionType" Title="ResolutionType" Align="Align.Center" Sortable="true" />
                    @if (App!.IsExpanded)
                    {
                        <PropertyColumn Property="x => x.ColorDepthType" Title="ColorDepthType" Align="Align.Center" Sortable="true" />
                        <PropertyColumn Property="x => x.SourceType" Title="SourceType" Align="Align.Center" Sortable="true" />
                        <PropertyColumn Property="x => x.Audio" Title="Audio" Align="Align.Center" Sortable="true" />
                        <PropertyColumn Property="x => x.VideoCodec" Title="VideoCodec" Align="Align.Center" Sortable="true" />
                    }
                    <PropertyColumn Property="x => x.ReleaseGroup" Title="ReleaseGroup" Align="Align.Center" Sortable="true" />

                </QuickGrid>

                <div class="quickgrid-pagination d-flex justify-content-between align-items-center">
                    <div class="ms-2">
                        <label class="me-2 small text-muted">Items:</label>
                        <select class="form-select form-select-sm d-inline-block w-auto" @bind="PaginationState.ItemsPerPage">
                            @foreach (var value in Enum.GetValues<ItemsPerPage>())
                            {
                                <option value="@((int)value)">@value</option>
                                <!-- Ili @(value.GetDisplayName()) ako koristite [Display] -->
                            }
                        </select>
                    </div>
                    <div class="w-75">
                        <Paginator State="PaginationState" />
                    </div>
                </div>
            </div>
        }

        @if (TmdbSearch is not null)
        {
            <div class="">
                <div class="m-3 d-flex justify-content-start align-items-center">
                    <button type="button" class="btn-close me-2" @onclick="() => TmdbSearch = null"></button>Close Search
                </div>

                @foreach (var movie in TmdbSearch.Results)
                {
                    <_SearchCardItem Movie="movie" />
                }
            </div>
        }
    </div>
}

@code {
    [CascadingParameter] AppState? App { get; set; }

    List<Movie> Entities = new();

    TmdbSearch? TmdbSearch;
    string SearchTerm = string.Empty;
    
    const string Title = "Movies";
    bool IsProcessing { get; set; } = true;

    readonly PaginationState PaginationState = new PaginationState { ItemsPerPage = 25 };



    protected override async Task OnInitializedAsync()
    {
        Entities = await Service.GetAllMoviesAsync();

        IsProcessing = false;
        StateHasChanged();
    }

    async Task HandleValidSubmit()
    {
        ArgumentNullException.ThrowIfNull(SearchTerm);

        TmdbSearch = await TmdbService.GetMovieAsync(SearchTerm);

        SearchTerm = string.Empty;
        StateHasChanged();
    }

    async Task HandleClick(string searchTerm, int? year)
    {
        ArgumentNullException.ThrowIfNull(SearchTerm);

        TmdbSearch = await TmdbService.GetMovieAsync(searchTerm, year.ToString());

        SearchTerm = string.Empty;
        StateHasChanged();
    }




    // protected override void OnInitialized()
    // {
    //     Entity = Service.ParseFilename("Iron.Man.2008.1080p.10bit.BluRay.8CH.x265.HEVC-PSA.mkv");
    //     IsProcessing = false;
    //     StateHasChanged();
    // }

    List<string> MovieFileNames = [
    "6.Underground.2019.1080p.10bit.WEBRip.6CH.x265.HEVC-PSA.mkv",
                                "2001.A.Space.Odyssey.1968.1080p.10bit.BrRip.6CH.x265.HEVC-PSA.mkv",
                                "2010 The Year We Make Contact 1984.mkv",
                                "A.Man.Called.Ove.A.K.A.En.man.som.heter.Ove.2015.SWEDISH.1080p.10bit.BluRay.6CH.x265.HEVC-PSA.mkv",
                                "Alien.1979.DIRECTOR'S.CUT.1080p.10bit.BluRay.6CH.x265.HEVC-PSA.mkv",
                                "Greyhound.2020.REPACK.1080p.10bit.WEBRip.6CH.x265.HEVC-PSA.mkv"
    ];
}
