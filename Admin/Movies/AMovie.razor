@page "/admin/movie/{id:guid?}"

@inject IMovieRepository Repository
@inject NavigationManager Navigation

<title>@Title</title>


@if (Input is not null)
{
    <div class="bg-header"></div>
    <div class="page @App?.GetContentClass()">
        <EditForm Model=@Input OnValidSubmit=@HandleValidSubmit>
            <DataAnnotationsValidator />

            <div class="d-flex justify-content-between align-items-end">
                <h1>@Title</h1>
                <div class="d-flex align-items-end gap-2">
                    <a href="admin/notes" class="btn btn-sm btn-secondary">back</a>
                    <button class="btn btn-lg btn-primary" type="submit">Save</button>
                </div>
            </div>

            <div class="mt-5 p-4 row rounded bg-transparent20">

                <div class="">
                    <span class="ms-1 p-sm">FileName</span>
                    <InputText @bind-Value="Input.FileName" class="form-control form-control-sm" placeholder="FileName" required />
                    <ValidationMessage For="() => Input.FileName" class="text-danger" />
                </div>

                <div class="col-12 col-md-6">
                    <div class="mt-4">
                        <span class="ms-1 p-sm">Title</span>
                        <InputText @bind-Value="Input.Title" class="form-control form-control-sm" placeholder="Title" required />
                        <ValidationMessage For="() => Input.Title" class="text-danger" />
                    </div>
                    <div class="mt-3">
                        <span class="ms-1 p-sm">Sort Title</span>
                        <InputText @bind-Value="Input.SortTitle" class="form-control form-control-sm" placeholder="Sort Title" />
                        <ValidationMessage For="() => Input.SortTitle" class="text-danger" />
                    </div>
                    <div class="mt-3">
                        <span class="ms-1 p-sm">Year</span>
                        <InputNumber @bind-Value="Input.Year" class="form-control form-control-sm" placeholder="Year" />
                        <ValidationMessage For="() => Input.Year" class="text-danger" />
                    </div>
                    <div class="mt-4">
                        <span class="ms-1 p-sm">Version</span>
                        <InputText @bind-Value="Input.Version" class="form-control form-control-sm" placeholder="Version" />
                        <ValidationMessage For="() => Input.Version" class="text-danger" />
                    </div>
                    <div class="mt-3">
                        <span class="ms-1 p-sm">Resolution</span>
                        <InputText @bind-Value="Input.Resolution" class="form-control form-control-sm" placeholder="Resolution" />
                        <ValidationMessage For="() => Input.Resolution" class="text-danger" />
                    </div>
                </div>

                <div class="col-12 col-md-6">
                    <div class="mt-4">
                        <span class="ms-1 p-sm">Tmdb Id</span>
                        <InputNumber @bind-Value="Input.TmdbId" class="form-control form-control-sm" placeholder="Tmdb Id" />
                        <ValidationMessage For="() => Input.TmdbId" class="text-danger" />
                    </div>
                    <div class="mt-3">
                        <span class="ms-1 p-sm">Tmdb Title</span>
                        <InputText @bind-Value="Input.TmdbTitle" class="form-control form-control-sm" placeholder="Tmdb Title" />
                        <ValidationMessage For="() => Input.TmdbTitle" class="text-danger" />
                    </div>
                    <div class="mt-3">
                        <span class="ms-1 p-sm">Tmdb ImageUrl</span>
                        <InputText @bind-Value="Input.TmdbImageUrl" class="form-control form-control-sm" placeholder="Tmdb ImageUrl" />
                        <ValidationMessage For="() => Input.TmdbImageUrl" class="text-danger" />
                    </div>
                    <div class="mt-4">
                        <span class="ms-1 p-sm">Imdb Id</span>
                        <InputText @bind-Value="Input.ImdbId" class="form-control form-control-sm" placeholder="Imdb Id" />
                        <ValidationMessage For="() => Input.ImdbId" class="text-danger" />
                    </div>
                    <div class="mt-3">
                        <span class="ms-1 p-sm">Imdb Rating</span>
                        <InputNumber @bind-Value="Input.ImdbRating" class="form-control form-control-sm" placeholder="Imdb Rating" />
                        <ValidationMessage For="() => Input.ImdbRating" class="text-danger" />
                    </div>
                </div>
            </div>
        </EditForm>
    </div>
}


@code {
    [CascadingParameter] AppState? App { get; set; }

    [Parameter] public Guid? Id { get; set; }

    MovieInput? Input { get; set; }

    string Title => Id.HasValue ? "Update Movie" : "Add Movie";



    protected override async Task OnParametersSetAsync()
    {
        if (Input is not null) return;
        if (!Id.HasValue) Input = new MovieInput();
        else
        {
            var result = await Repository.GetByIdAsync((Guid)Id);
            if (!result.Success || result.Data is null) return;
            Input = result.Data.ToInput();
        }
    }

    async Task HandleValidSubmit()
    {
        var result = Id is null
            ? await Repository.AddAsync(Input)
            : await Repository.UpdateAsync(Id.Value, Input);

        if (result.Success) Navigation.NavigateTo("/admin/movies");
        await App!.ShowToast(result.Message, result.Success ? "success" : "error");
        StateHasChanged();
    }
}