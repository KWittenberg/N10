@page "/chat"

@inject LocalAiService AiService
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration

<PageTitle>Local AI Chat (Llama.cpp)</PageTitle>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">
                            <i class="bi bi-cpu"></i> Local AI Chat (Llama.cpp)
                        </h4>
                        <small class="opacity-75">Powered by TinyLlama - 100% offline</small>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" @bind="enableAdvanced" />
                        <label class="form-check-label text-white">Advanced Mode</label>
                    </div>
                </div>

                <div class="card-body chat-container" style="height: 500px; overflow-y: auto;">
                    <div id="chat-messages">
                        <!-- System Info -->
                        <div class="alert alert-info mb-3">
                            <h6><i class="bi bi-info-circle"></i> System Information</h6>
                            <small>@systemInfo</small>
                        </div>

                        @foreach (var message in chatMessages)
                        {
                            <div class="@GetMessageClass(message.IsUser)">
                                <div class="message-bubble">
                                    @if (message.IsUser)
                                    {
                                        <strong>Vi:</strong>
                                    }
                                    else
                                    {
                                        <strong class="text-primary">AI:</strong>
                                    }
                                    @message.Text
                                </div>
                                <small class="text-muted">@message.Timestamp.ToString("HH:mm:ss")</small>
                                @if (!message.IsUser)
                                {
                                    <small class="text-muted ms-2">@message.Tokens tokens</small>
                                }
                            </div>
                        }
                    </div>
                </div>

                <div class="card-footer">
                    <div class="input-group mb-2">
                        <input type="text"
                               class="form-control"
                               placeholder="Postavite pitanje lokalnoj AI..."
                               @bind="userInput"
                               @onkeypress="HandleKeyPress"
                               disabled="@isLoading" />
                        <button class="btn btn-primary"
                                @onclick="SendMessage"
                                disabled="@(isLoading || !AiService.IsConfigured())">
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                <span class="ms-1">Obrađujem...</span>
                            }
                            else
                            {
                                <i class="bi bi-send"></i>
                                <span>Pošalji</span>
                            }
                        </button>
                    </div>

                    @if (!AiService.IsConfigured())
                    {
                        <div class="alert alert-warning mb-2">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Konfiguracija nije pronađena!</strong><br />
                            Provjerite da li su llama-cli.exe i GGUF model na odgovarajućim lokacijama.
                        </div>
                    }

                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-cpu"></i>
                            Model: @Path.GetFileName(Configuration["LocalAI:ModelPath"])
                        </small>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="ClearChat">
                            <i class="bi bi-trash"></i> Očisti
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@code {
    List<ChatMessage> chatMessages = new();
    string userInput = string.Empty;
    string systemInfo = string.Empty;

    bool isLoading = false;
    bool enableAdvanced = false;
    

    protected override void OnInitialized()
    {
        systemInfo = AiService.GetConfigurationInfo();

        // Dodaj pozdravnu poruku
        chatMessages.Add(new ChatMessage
        {
            Text = "Pozdrav! Ja sam lokalna AI implementacija pomoću TinyLlama modela. Postavite mi pitanje!",
            IsUser = false,
            Timestamp = DateTime.Now,
            Tokens = 0
        });
    }

    async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(userInput)) return;

        // Dodaj korisnikovu poruku
        var userMessage = new ChatMessage
        {
            Text = userInput,
            IsUser = true,
            Timestamp = DateTime.Now
        };
        chatMessages.Add(userMessage);

        var currentInput = userInput;
        userInput = string.Empty;
        isLoading = true;

        StateHasChanged();

        try
        {
            var stopwatch = Stopwatch.StartNew();
            var aiResponse = await AiService.GetResponseAsync(currentInput);
            stopwatch.Stop();

            // Procijeni broj tokena (gruba procjena)
            var estimatedTokens = aiResponse.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length;

            chatMessages.Add(new ChatMessage
            {
                Text = aiResponse,
                IsUser = false,
                Timestamp = DateTime.Now,
                Tokens = estimatedTokens,
                ProcessingTime = stopwatch.ElapsedMilliseconds
            });
        }
        catch (Exception ex)
        {
            chatMessages.Add(new ChatMessage
            {
                Text = $"Greška pri komunikaciji s AI modelom: {ex.Message}",
                IsUser = false,
                Timestamp = DateTime.Now
            });
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
            await JSRuntime.InvokeVoidAsync("scrollToBottom", "chat-messages");
        }
    }

    async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading) await SendMessage();
    }

    void ClearChat()
    {
        chatMessages.Clear();
        StateHasChanged();
    }

    string GetMessageClass(bool isUser) => isUser ? "user-message text-end mb-3" : "ai-message text-start mb-3";
    

    public class ChatMessage
    {
        public string Text { get; set; } = string.Empty;
        public bool IsUser { get; set; }
        public DateTime Timestamp { get; set; }
        public int Tokens { get; set; }
        public long? ProcessingTime { get; set; }
    }
}