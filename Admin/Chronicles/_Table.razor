@inject IDbContextFactory<ApplicationDbContext> ContextFactory

<div class="quickgrid-wrapper table-responsive">
    <QuickGrid Class="p-sm table table-hover align-middle" Items="FilteredChronicles?.AsQueryable()" Pagination="PaginationState">

        <div class="p-2 d-flex justify-content-between align-items-center">
            <h4 class="p-0 m-0 ms-2">@Title</h4>
            <div class="d-inline-flex align-items-center">
                <i class="bi bi-search"></i>
                <input type="search" class="ms-2 form-control form-control-sm" autofocus @bind="SearchTerm" @bind:event="oninput" placeholder=" search .." />
            </div>
            <div class="me-2 d-inline-flex align-items-center" stile="width: 5rem;">
                <label class="me-2 small text-muted">Items:</label>
                <select class="form-select form-select-sm" @bind="PaginationState.ItemsPerPage">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                </select>
            </div>
        </div>

        @* <PropertyColumn Property="x => x.Id" Title="Id" Align="Align.Center" Sortable="true" />
        @if (App!.IsExpanded)
        {
            <PropertyColumn Property="x => x.Day" Title="Day" Align="Align.Center" Sortable="true" />
            <PropertyColumn Property="x => x.Month" Title="Month" Align="Align.Center" Sortable="true" />
            <PropertyColumn Property="x => x.Year" Title="Year" Align="Align.Center" Sortable="true" />
        } *@
        <TemplateColumn Title="✅" Align="Align.Center" SortBy="@isApprovedSort">
            <span><i class="fas @(context.IsApproved ? "fa-check-circle" : "fa-times-circle") fa-lg @(context.IsApproved ? "text-success" : "text-danger")"></i></span>
        </TemplateColumn>
        <TemplateColumn Title="Datum" Align="Align.Center" SortBy="@dateSort">
            <span class="@(context.Date.HasValue ? "text-success" : "text-danger")">@(context.Date.HasValue? context.Date.Value.ToShortDateString() : "NEPOZNAT")</span>
        </TemplateColumn>
        <PropertyColumn Property="x => x.Title" Title="Title" Align="Align.Center" Sortable="true" />

        <TemplateColumn Title="Content" Align="Align.Left">
            @if (context.EnhancedContent is null)
            {
                <span title="@context.Content">@(App!.IsExpanded ? context.Content : $"{context.Content[..Math.Min(80, context.Content.Length)]}...")</span>
            }
            else
            {
                <span class="text-core" title="@context.EnhancedContent">@(App!.IsExpanded ? context.EnhancedContent : $"{context.EnhancedContent?[..Math.Min(80, context.EnhancedContent.Length)]}...")</span>
            }
        </TemplateColumn>

        @* <TemplateColumn Title="Ok" Align="Align.Center" SortBy="@okSort">
            <span>@(context.Date.HasValue ? "✅" : "❌")</span>
        </TemplateColumn> *@

        <PropertyColumn Property="x => x.Type" Title="Type" Align="Align.Center" Sortable="true" />

        <TemplateColumn Title="Actions" Align="Align.Center">
            <ChildContent>
                <div class="d-flex justify-content-end align-items-center gap-2">
                    @if (context.Day == Today.Day && context.Month == Today.Month)
                    {
                        <span @onclick="() => Chronicle = context" title="Post"><i class="bi bi-p-square"></i></span>
                    }
                    <span @onclick="() => OnEdit.InvokeAsync(context)" title="Edit"><i class="bi bi-pencil-square"></i></span>
                    <span class="text-danger" @onclick="() => Delete(context)"><i class="bi bi-trash"></i></span>
                </div>
            </ChildContent>
        </TemplateColumn>
    </QuickGrid>
    <div class="quickgrid-pagination">
        <Paginator State="PaginationState" />
    </div>
</div>
<_Post Chronicle="Chronicle" />


@code {
    [CascadingParameter] AppState? App { get; set; }
    [Parameter, EditorRequired] public List<Chronicle>? Chronicles { get; set; }
    [Parameter] public string? Title { get; set; }
    [Parameter] public EventCallback<Chronicle> OnEdit { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }
    [Parameter, EditorRequired] public PaginationState PaginationState { get; set; } = default!;

    DateTime Today;
    string? SearchTerm;
    Chronicle? Chronicle;
    List<Chronicle>? FilteredChronicles
    {
        get
        {
            if (string.IsNullOrWhiteSpace(SearchTerm)) return Chronicles;
            var term = SearchTerm!.ToLowerInvariant();
            return Chronicles?
                .Where(x =>
                    (x.Title != null && x.Title.ToLowerInvariant().Contains(term)) ||
                    (x.Content != null && x.Content.ToLowerInvariant().Contains(term)) ||
                    (x.EnhancedContent != null && x.EnhancedContent.ToLowerInvariant().Contains(term))
                )
                .ToList();
        }
    }

    GridSort<Chronicle> dateSort = GridSort<Chronicle>.ByAscending(x => x.Date);
    // GridSort<Chronicle> okSort = GridSort<Chronicle>.ByAscending(x => x.Date.HasValue);
    GridSort<Chronicle> isApprovedSort = GridSort<Chronicle>.ByAscending(x => x.IsApproved);
    
    // Prebačeno u AChronicles.razor
    // PaginationState? paginationState;
    // PaginationState PaginationState => paginationState ??= new PaginationState { ItemsPerPage = Title == "5 Days" ? 10 : 25 };



    protected override void OnParametersSet()
    {
        var croatiaZone = TimeZoneInfo.FindSystemTimeZoneById("Central European Standard Time");
        Today = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, croatiaZone).Date;
    }

    #region ---> DELETE
    void Delete(Chronicle input)
    {
        App?.ShowDeleteConfirmation(input.Title, input.Id.ToString(), EventCallback.Factory.Create(this, () => ConfirmDelete(input)));
    }

    async Task ConfirmDelete(Chronicle input)
    {
        try
        {
            await using var context = await ContextFactory.CreateDbContextAsync();
            var entity = context.Chronicles.Find(input.Id);
            if (entity is null)
            {
                await App!.ShowToast($"{Title} not found!", "error");
                return;
            }

            context.Chronicles.Remove(entity);
            await context.SaveChangesAsync();
            await App!.ShowToast($"{Title} deleted successfully!", "success");
            await OnDelete.InvokeAsync();
        }
        catch (Exception ex)
        {
            await App!.ShowToast($"Failed to delete {Title}: {ex.Message}", "error");
        }
    }
    #endregion
}
