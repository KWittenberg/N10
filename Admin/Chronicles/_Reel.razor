@inject IJSRuntime JS

<!-- Post Modal Component -->
<div class="modal fade @ShowClass" style="display: @(Chronicle is not null ? "block" : "none"); background: rgba(0,0,0,0.50); backdrop-filter: blur(4px);" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content text-white border-0 bg-transparent">

            <!-- 1. HEADER -->
            <div class="modal-header d-flex justify-content-between align-items-baseline border-0 w-100">
                <button type="button" class="btn btn-outline-secondary rounded-circle p-2" style="width: 40px; height: 40px;" @onclick="Close"><i class="bi bi-x-lg"></i></button>
                <h6 class="h6t">Reel</h6>
                <button type="button" class="px-3 btn btn-primary rounded-pill" @onclick="@(string.IsNullOrEmpty(PreviewImageSrc) ? GenerateImage : SaveImageToDisk)" disabled="@IsWorking">
                    <span class="@(IsWorking ? "spinner-border spinner-border-sm me-2" : "")"></span>
                    <span>@(string.IsNullOrEmpty(PreviewImageSrc) ? "Generate Image" : "Save Image")</span>
                </button>
            </div>

            <!-- 2. BODY (Tekst) -->
            @* <div class="p-0 pb-0 modal-body">
                <InputTextArea @bind-Value="PostText" class="form-control bg-dark-subtle text-white border-0 p-4" rows="12"></InputTextArea>
            </div> *@

            <!-- 3. FOOTER (Preview Slike) -->
            <div class="mt-4 d-flex justify-content-center align-items-center">

                @if (!string.IsNullOrEmpty(PreviewImageSrc))
                {
                    <div class="text-center">
                        <p class="small mb-2">Jpeg</p>
                        <img src="@PreviewImageSrc" class="img-fluid" style="width: 540px;"/>
                    </div>
                }
                else if (Chronicle is not null)
                {
                    <div class="text-center">
                        <p class="small mb-2">HTML</p>
                        <div id="capture-target" class="p-4 text-start" style="z-index: 1;">
                            @* <div class="bg-noise"></div> *@

                            <!-- RUDINSKA GLAVA -->
                            <div class="rudina-bg-wrapper">
                                <img src="@CurrentHeadUrl" class="rudina-big-head" alt="Rudinska glava" />
                            </div>
                            <div class="mt-5" style="z-index: 2;">
                                <div class="ps-3 d-inline-block border-start border-warning border-3">
                                    <span class="text-uppercase text-warning small fw-bold" style="letter-spacing: 3px;">Požeški Vremeplov</span>
                                    <span class="mt-1 d-block text-muted small" style="font-family: var(--kw-v-font-title);">autor: Tomislav Wittenberg</span>
                                </div>
                                <h1 class="mt-3 font-display fw-bold display-1 lh-1">
                                    <span class="pb-1 d-block text-gradient-gold">@SelectedDate.Day.</span>
                                    <span class="d-block" style="color: var(--kw-v-primary);">@SelectedDate.Month.ToCroatianMonthName()</span>
                                </h1>
                                <div class="mt-5">
                                    <N10.Pages.Chronicles._ChronicleCard Item="Chronicle" Share="false" />
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [CascadingParameter] AppState? App { get; set; }
    [Parameter] public Chronicle? Chronicle { get; set; }

    string ShowClass => Chronicle is not null ? "show d-block" : string.Empty;
    string PostText = string.Empty;

    string PreviewImageSrc = string.Empty; // Ovdje spremamo Base64 string za prikaz
    byte[]? ImageBytes = null; // Ovdje spremamo bajtove slike za slanje na Facebook

    bool IsWorking = false;

    DateTime SelectedDate;
    string CurrentHeadUrl = string.Empty;

    protected override void OnParametersSet()
    {
        if (Chronicle is null) return;

        var croatiaZone = TimeZoneInfo.FindSystemTimeZoneById("Central European Standard Time");
        SelectedDate = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, croatiaZone).Date;

        int headNumber = Random.Shared.Next(1, 19);
        CurrentHeadUrl = $"/img/heads/{headNumber:00}.png";
    }

    async Task GenerateImage()
    {
        // 1. Učitaj modul (s onim trikom protiv cache-a)
        await using var jsModule = await JS.InvokeAsync<IJSObjectReference>("import", $"./Admin/Chronicles/_Reel.razor.js?v={DateTime.Now.Ticks}");

        try
        {
            var timer = BusyMonitor.Start(ref IsWorking);
            StateHasChanged();
            // 2. DOHVATI STREAM REFERENCU (Ne ruši SignalR!)
            var dataReference = await jsModule.InvokeAsync<IJSStreamReference>("getCardImageStream", "capture-target");

            // 3. OTVORI STREAM I ČITAJ (Limit 10MB)
            using var dataStream = await dataReference.OpenReadStreamAsync(maxAllowedSize: 10 * 1024 * 1024);

            using var ms = new MemoryStream();
            await dataStream.CopyToAsync(ms);

            // 4. SPREMI BAJTOVE
            byte[] bytes = ms.ToArray();

            if (bytes.Length > 0)
            {
                ImageBytes = bytes;
                var base64 = Convert.ToBase64String(bytes);
                PreviewImageSrc = $"data:image/jpeg;base64,{base64}";
                StateHasChanged();
            }
            var duration = timer.Stop(ref IsWorking);
            await App!.ShowNotify($"Image Created!", "success", $"Took {duration}");
        }
        catch (Exception ex)
        {
            await App!.ShowToast($"GREŠKA KOD SLIKANJA: {ex.Message}", "error");
        }
    }

    async Task SaveImageToDisk()
    {
        if (ImageBytes is null) await GenerateImage();
        if (ImageBytes is not null)
        {
            var timer = BusyMonitor.Start(ref IsWorking);

            try
            {
                string folderPath = @"C:\Reels";
                if (!Directory.Exists(folderPath)) Directory.CreateDirectory(folderPath);

                string fileName = $"{Chronicle?.Title?.Replace(":", " -")} {DateTime.Now:ddMMyyyy}.jpg";
                string fullPath = Path.Combine(folderPath, fileName);

                await File.WriteAllBytesAsync(fullPath, ImageBytes);

                await App!.ShowNotify($"Spremljeno: {fileName}", "success", $"Lokacija: {folderPath} | {timer.Stop(ref IsWorking)}");

                Close();
            }
            catch (Exception ex)
            {
                timer.Stop(ref IsWorking);
                await App!.ShowToast($"Greška kod spremanja: {ex.Message}", "error");
            }
        }
    }

    void Close()
    {
        Chronicle = null;
        PostText = string.Empty;

        PreviewImageSrc = string.Empty;
        ImageBytes = null;
    }
}