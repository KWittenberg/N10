@page "/admin/chronicles"

@inject IDbContextFactory<ApplicationDbContext> contextFactory
@inject ChronicleService Service

<title>@Title</title>

<_PageHeader Title="@Title" />

@if (Chronicles is null)
{
    <_Loading />
}
else
{
    <div class="mt-3 @App?.GetContentClass()">
        <_Table Chronicles="Today" Title="Today" />
        <_Table Chronicles="Chronicles" Title="@Title" />
    </div>
}


@code {
    [CascadingParameter] AppState? App { get; set; }

    List<Chronicle>? Chronicles;
    List<Chronicle>? Today;
    const string Title = "Chronicle";



    protected override async Task OnInitializedAsync() => await LoadAsync();

    async Task LoadAsync()
    {
        var croatiaZone = TimeZoneInfo.FindSystemTimeZoneById("Central European Standard Time");
        var nowInCroatia = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, croatiaZone);

        await using var db = await contextFactory.CreateDbContextAsync();

        Chronicles = await db.Chronicles.AsNoTracking().ToListAsync();

        Today = Chronicles.Where(c => c.Date.HasValue && c.Date.Value.Month == nowInCroatia.Month && c.Date.Value.Day == nowInCroatia.Day).ToList();
    }
}