@inject IJSRuntime JS

<!-- Post Modal Component -->
<div class="modal fade @ShowClass" style="display: @(Chronicle is not null ? "block" : "none"); background: rgba(0,0,0,0.50); backdrop-filter: blur(4px);" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">

        <div class="modal-content text-white border-0 bg-transparent">

            <!-- 1. HEADER -->
            <div class="modal-header d-flex justify-content-between align-items-center border-0 w-100">
                <button type="button" class="btn btn-outline-secondary rounded-circle p-2" style="width: 40px; height: 40px;" @onclick="() => Chronicle = null"><i class="bi bi-x-lg"></i></button>
                <button type="button" class="btn btn-warning rounded-pill px-4 fw-bold" @onclick="PostToFacebook">POST <i class="bi bi-send-fill ms-2"></i></button>
            </div>

            <!-- 2. BODY (Tekst) -->
            <div class="p-0 pb-0 modal-body">
                <InputTextArea @bind-Value="PostText" class="form-control bg-dark-subtle text-white border-0 p-4" rows="12"></InputTextArea>
            </div>

            <!-- 3. FOOTER (Preview Slike) -->
            <div class="mt-4 justify-content-center">
                @if (Chronicle is not null)
                {
                    <div class="image-bg">
                        <div class="bg-noise"></div>
                        <div class="bg-blob blob-gold"></div>
                        <div class="bg-blob blob-blue"></div>
                        <N10.Pages.Chronicles._ChronicleCard Item="Chronicle" Share="false" />
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public Chronicle? Chronicle { get; set; }

    string ShowClass => Chronicle is not null ? "show d-block" : string.Empty;
    string PostText = string.Empty;


    protected override void OnParametersSet()
    {
        if (Chronicle is null) return;

        var sb = new StringBuilder();
        sb.AppendLine("POŽEŠKI VREMEPLOV - DOGODILO SE NA DANAŠNJI DAN");
        sb.AppendLine("autor: Tomislav Wittenberg");
        sb.AppendLine("");
        sb.AppendLine($"📜 {Chronicle.Title}");
        sb.AppendLine("");
        sb.AppendLine(string.IsNullOrEmpty(Chronicle.EnhancedContent) ? Chronicle.Content : Chronicle.EnhancedContent);
        sb.AppendLine("");
        sb.AppendLine("#Požeški #Vremeplov #Wittenberg #Požega #Povijest #Baština");

        PostText = sb.ToString();
        PostText = PostText.TrimEnd();
    }

    async Task PostToFacebook()
    {
        // 1. Zovi JS da generira sliku (SCALE 2 = 1200px)
        // Moraš u JS dodati { scale: 2 } u opcije html2canvasa
        await using var jsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./Pages/ChroniclesVremeplov.razor.js");

        // Vrati Base64 string
        string base64Image = await jsModule.InvokeAsync<string>("getCardImageBase64", "capture-target");

        if (!string.IsNullOrEmpty(base64Image))
        {
            // 2. Pretvori u bajtove
            var base64Data = base64Image.Split(',')[1];
            byte[] imageBytes = Convert.FromBase64String(base64Data);

            // 3. Šalji na API (Otkomentiraj kad spojiš MetaService)
            // await Facebook.PostImageFromMemoryAsync(PostText, imageBytes);

            // Za test:
            Console.WriteLine($"Slika spremna! Veličina: {imageBytes.Length / 1024} KB");
            //await Close();
        }
    }
}