@page "/chat"
@layout FrontLayout

@inject LocalAiService AiService
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration

<PageTitle>Local AI Chat</PageTitle>

<div class="mt-5 @App?.GetContentClass()">

    @if (!AiService.IsConfigured())
    {
        <div class="alert alert-warning mb-2">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Model Not Found !</strong><br />
            Check that GGUF model are in the correct locations.
        </div>
    }

    <p-sm class="text-muted"><i class="bi bi-cpu me-2"></i>Model: @Path.GetFileName(Configuration["LocalAI:TinyPath"])</p-sm>

    <div class="mt-5 mb-5 chat-container">
        @foreach (var message in chatMessages)
        {
            <div class="@GetMessageClass(message.IsUser)">
                <div class="message-bubble">
                    @message.Text
                </div>
                <p class="ms-3 p-sm text-muted">
                    @message.Timestamp.ToString("HH:mm:ss")
                    @if (!message.IsUser && message.Tokens > 0)
                    {
                        <span class="text-muted"> | @message.Tokens tokens</span>
                    }
                </p>
            </div>
        }
    </div>

    <div class="">
        <div class="mb-5 input-group">
            <input type="text" class="form-control" placeholder="ask.." @bind="userInput" @onkeypress="HandleKeyPress" disabled="@isLoading" />

            <button class="btn btn-primary" @onclick="SendMessage" disabled="@(isLoading || !AiService.IsConfigured())">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                    <span class="ms-1">working...</span>
                }
                else
                {
                    <i class="bi bi-send"></i>
                }
            </button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="ClearChat"><i class="bi bi-trash"></i> Clear Chat</button>
        </div>
    </div>
</div>


@code {
    [CascadingParameter] AppState? App { get; set; }

    List<ChatMessage> chatMessages = new();
    string userInput = string.Empty;
    string systemInfo = string.Empty;

    bool isLoading = false;


    protected override void OnInitialized()
    {
        systemInfo = AiService.GetConfigurationInfo();

        App?.ShowToast(systemInfo, "info");

        // Dodaj pozdravnu poruku
        chatMessages.Add(new ChatMessage
        {
            Text = $"Hi! I'm {systemInfo}",
            IsUser = false,
            Timestamp = DateTime.Now,
            Tokens = 0
        });
    }

    async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(userInput)) return;

        // Dodaj korisnikovu poruku
        var userMessage = new ChatMessage
        {
            Text = userInput,
            IsUser = true,
            Timestamp = DateTime.Now
        };
        chatMessages.Add(userMessage);

        var currentInput = userInput;
        userInput = string.Empty;
        isLoading = true;

        StateHasChanged();

        try
        {
            var stopwatch = Stopwatch.StartNew();
            var aiResponse = await AiService.GetResponseAsync(currentInput);
            stopwatch.Stop();

            // Procijeni broj tokena (gruba procjena)
            var estimatedTokens = aiResponse.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length;

            chatMessages.Add(new ChatMessage
            {
                Text = aiResponse,
                IsUser = false,
                Timestamp = DateTime.Now,
                Tokens = estimatedTokens,
                ProcessingTime = stopwatch.ElapsedMilliseconds
            });
        }
        catch (Exception ex)
        {
            chatMessages.Add(new ChatMessage
            {
                Text = $"Greška pri komunikaciji s AI modelom: {ex.Message}",
                IsUser = false,
                Timestamp = DateTime.Now
            });
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
            await JSRuntime.InvokeVoidAsync("scrollToBottom", "chat-messages");
        }
    }

    async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading) await SendMessage();
    }

    void ClearChat()
    {
        chatMessages.Clear();
        StateHasChanged();
    }

    string GetMessageClass(bool isUser) => isUser ? "user-message text-end mb-3" : "ai-message text-start mb-3";


    public class ChatMessage
    {
        public string Text { get; set; } = string.Empty;
        public bool IsUser { get; set; }
        public DateTime Timestamp { get; set; }
        public int Tokens { get; set; }
        public long? ProcessingTime { get; set; }
    }
}