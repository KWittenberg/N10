@page "/movies"
@layout FrontLayout

@inject IMovieRepository Repository
@inject IJSRuntime JSRuntime

<title>@Title</title>


<div class="mt-5 @App?.GetContentClass()">
    <!-- Mobile Filter Toggle -->
    @* <div class="col-12 d-lg-none mb-3"> *@

    <!-- Search & Filters -->
    <div class="d-flex justify-content-center align-items-center gap-4">
        <div class="input-group">
            <input type="text" class="form-control" @bind="SearchTerm" @oninput="OnSearchInput" placeholder=" Search Movies..." />
            @if (!string.IsNullOrEmpty(SearchTerm))
            {
                <button class="btn btn-outline-secondary" @onclick="ClearSearch">X</button>
            }
        </div>
        <div class="">
            <button class="btn btn-outline-primary w-100" @onclick="ToggleMobileFilters">
                <i class="fas fa-filter"></i> Filters
                @if (HasActiveFilters)
                {
                    <span class="badge bg-primary ms-2">@GetActiveFilterCount</span>
                }
            </button>
        </div>
    </div>

    <!-- Filter Options -->
    @* <div class="@(ShowMobileFilters ? "d-block" : "d-none d-lg-block")"> *@
    <div class="mt-4 @(ShowMobileFilters ? "d-block" : "d-none")">
        <div class="card bg-transparent10">
            <div class="card-body">

                <!-- Alphabet Filter -->
                <div class="alphabet-filter">
                    <button class="btn @(filter.Letter == null ? "btn-primary" : "btn-outline-primary") btn-sm m-1" @onclick="() => SetLetterFilter(null)">
                        All
                    </button>
                    @foreach (var letter in "ABCDEFGHIJKLMNOPQRSTUVWXYZ")
                    {
                        <button class="btn @(filter.Letter == letter.ToString() ? "btn-primary" : "btn-outline-primary") btn-sm m-1" @onclick="() => SetLetterFilter(letter.ToString())">
                            @letter
                        </button>
                    }
                </div>

                <div class="row">
                    <div class="p-4 col-md-6">
                        <!-- Resolutions -->
                        <div class="mt-2">
                            <label class="form-label">Resolution</label>
                            <div class="resolution-filter">
                                @foreach (var resolution in filterOptions?.AvailableResolutions ?? new())
                                {
                                    <button class="btn @(filter.Resolutions?.Contains(resolution) == true ? "btn-primary" : "btn-outline-primary") btn-sm m-1"
                                            @onclick="() => ToggleResolution(resolution)">
                                        @resolution
                                    </button>
                                }
                            </div>
                        </div>
                        <!-- Year Range -->
                        <div class="mt-3">
                            <label class="form-label">Year: @YearFrom - @YearTo</label>
                            <div class="row">
                                <div class="col-6">
                                    <select class="form-select" @bind="YearFrom">
                                        <option value="">From Year</option>
                                        @foreach (var year in filterOptions?.AvailableYears ?? new())
                                        {
                                            <option value="@year">@year</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-6">
                                    <select class="form-select" @bind="YearTo">
                                        <option value="">To Year</option>
                                        @foreach (var year in filterOptions?.AvailableYears ?? new())
                                        {
                                            <option value="@year">@year</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Genres -->
                    <div class="p-4 col-md-6">
                        <label class="form-label">Geners</label>
                        <div class="genre-buttons" style="max-height: 200px; overflow-y: auto;">
                            @foreach (var genre in filterOptions?.AvailableGenres ?? new())
                            {
                                <button class="btn @(filter.Genres?.Contains(genre) == true ? "btn-primary" : "btn-outline-primary") btn-sm m-1" @onclick="() => ToggleGenre(genre)">
                                    @genre
                                </button>
                            }
                        </div>
                    </div>
                    <!-- Genres checkbox-->
                    @* <div class="col-md-6">
                        <label class="form-label">Genres</label>
                        <div class="genre-filter" style="max-height: 200px; overflow-y: auto;">
                            @foreach (var genre in filterOptions?.AvailableGenres ?? new())
                            {
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="genre-@genre" checked="@(filter.Genres?.Contains(genre) == true)"
                                           @onchange="(e) => ToggleGenre(genre, e.Value)" />
                                    <label class="form-check-label" for="genre-@genre">@genre</label>
                                </div>
                            }
                        </div>
                    </div> *@
                </div>

                <!-- Sort & Action Buttons -->
                <div class="p-2 d-flex justify-content-between align-items-center">
                    <div>
                        <select class="form-select" @bind="SortBy">
                            <option value="title">Title [A-Z]</option>
                            <option value="title_desc">Title [Z-A]</option>
                            <option value="year">Year [old]</option>
                            <option value="year_desc">Year [new]</option>
                            <option value="rating">IMDb ocjena</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" @onclick="ApplyFilters"><i class="bi bi-search me-2"></i>Apply Filters</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Main Content -->
<div class="mt-5 mb-5 @App?.GetContentClass()">
    <!-- Active Filters -->
    @if (HasActiveFilters)
    {
        <div class="mb-4 card border-0 bg-transparent20">
            <div class="px-4 py-2 card-body d-flex justify-content-between align-items-center">
                <div class="d-flex flex-wrap align-items-center gap-2">
                    <small class="text-muted">Active filters:</small>
                    @if (!string.IsNullOrEmpty(filter.Letter))
                    {
                        <span class="badge bg-primary">
                            Slovo: @filter.Letter
                            <button class="btn-close btn-close-white ms-1" @onclick="() => SetLetterFilter(null)"></button>
                        </span>
                    }
                    @if (filter.YearFrom.HasValue || filter.YearTo.HasValue)
                    {
                        <span class="badge bg-primary">
                            Year: @(filter.YearFrom?.ToString() ?? "...") - @(filter.YearTo?.ToString() ?? "...")
                            <button class="btn-close btn-close-white ms-1" @onclick="ClearYearFilter"></button>
                        </span>
                    }
                    @foreach (var genre in filter.Genres ?? new())
                    {
                        <span class="badge bg-success">
                            @genre
                            <button class="btn-close btn-close-white ms-1" @onclick="() => ToggleGenre(genre, false)"></button>
                        </span>
                    }
                    @foreach (var res in filter.Resolutions ?? new())
                    {
                        <span class="badge bg-warning text-dark">
                            @res
                            <button class="btn-close ms-1" @onclick="() => ToggleResolution(res)"></button>
                        </span>
                    }
                </div>
                @if (HasActiveFilters)
                {
                    <button class="btn btn-outline-danger btn-sm" @onclick="ResetFilters">X</button>
                }
            </div>
        </div>
    }

    <!-- Results Count & Button Grid/List -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Movies: <span class="ms-2 text-primary">@(Entities.Count > 0 ? "..." : "0")</span></h5>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" @onclick="ToggleViewMode">
                <i class="bi @(IsGridView ? "bi-list" : "bi-grid")"></i>
            </button>
        </div>
    </div>

    @if (IsProcessing && !Entities.Any())
    {
        <_Loading />
    }
    else if (!Entities.Any())
    {
        <!-- Nema pronađenih filmova -->
        <div class="text-center py-5">
            @* <i class="fas fa-film fa-3x text-muted mb-3"></i> *@
            <i class="bi bi-film"></i>
            <h4 class="mt-3 text-muted">Nema pronađenih filmova</h4>
            <p class="text-muted">Pokušajte promijeniti filtere</p>
            <button class="btn btn-primary" @onclick="ResetFilters">Reset All</button>
        </div>
    }
    else
    {
        <div class="@(IsGridView ? "row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 row-cols-xxl-6" : "list-view")">
            @foreach (var movie in Entities)
            {
                @if (IsGridView)
                {
                    <_MovieCard Item="movie" />
                }
                else
                {
                    <_MovieListItem Item="movie" />
                }
            }
        </div>

        @if (IsLoadingMore)
        {
            <div class="text-center my-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Učitavanje...</span>
                </div>
            </div>
        }

        @if (HasMoreData && !IsLoadingMore)
        {
            <div @ref="LoadMoreTrigger" class="text-center my-4">
                <button class="btn btn-primary" @onclick="LoadMoreData">
                    Učitaj još filmova (@(CurrentPage* PageSize)/@TotalCount)
                </button>
            </div>
        }

        @if (!HasMoreData && Entities.Any())
        {
            <div class="text-center my-4 text-muted">
                <p>Prikazani su svi filmovi (@TotalCount)</p>
            </div>
        }
    }
</div>


@code {
    [CascadingParameter] AppState? App { get; set; }

    List<MovieDto> Entities { get; set; } = new();
    const string Title = "Movies";

    // Pagination
    int CurrentPage = 0;
    int PageSize = 100;
    int TotalCount = 0;
    bool HasMoreData = true;
    bool IsProcessing = true;
    bool IsLoadingMore = false;

    // Filters
    MovieFilter filter = new();
    FilterOptionsDto? filterOptions;
    //string SearchTerm = string.Empty;

    // UI State
    bool ShowMobileFilters = false;
    bool IsGridView = true;
    ElementReference LoadMoreTrigger;
    DotNetObjectReference<Movies>? DotNetHelper;

    // Computed properties
    bool HasActiveFilters => !string.IsNullOrEmpty(filter.Letter) ||
                            filter.YearFrom.HasValue || filter.YearTo.HasValue ||
                            (filter.Genres?.Any() == true) ||
                            (filter.Resolutions?.Any() == true);

    int GetActiveFilterCount => (string.IsNullOrEmpty(filter.Letter) ? 0 : 1) +
                              ((filter.YearFrom.HasValue || filter.YearTo.HasValue) ? 1 : 0) +
                              (filter.Genres?.Count ?? 0) +
                              (filter.Resolutions?.Count ?? 0);

    protected override async Task OnInitializedAsync()
    {
        await LoadFilterOptions();
        await LoadInitialData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            DotNetHelper = DotNetObjectReference.Create(this);
            await using var jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/Pages/Movies/Movies.razor.js");
            await jsModule.InvokeVoidAsync("registerInfiniteScroll", DotNetHelper);
        }
    }

    async Task LoadFilterOptions()
    {
        var result = await Repository.GetFilterOptionsAsync();
        if (result.Success) filterOptions = result.Data;
    }

    async Task LoadInitialData()
    {
        IsProcessing = true;
        CurrentPage = 1;
        StateHasChanged();

        var result = await Repository.GetFilteredPagedAsync(CurrentPage, PageSize, filter);
        if (result.Success && result.Data != null)
        {
            Entities = result.Data.Items;
            TotalCount = result.Data.TotalCount;
            HasMoreData = result.Data.HasNextPage;
        }

        IsProcessing = false;
        StateHasChanged();
    }

    async Task LoadMoreData()
    {
        if (IsLoadingMore || !HasMoreData) return;

        IsLoadingMore = true;
        StateHasChanged();

        CurrentPage++;

        var result = await Repository.GetFilteredPagedAsync(CurrentPage, PageSize, filter);
        if (result.Success && result.Data != null)
        {
            Entities.AddRange(result.Data.Items);
            HasMoreData = result.Data.HasNextPage;
        }
        else HasMoreData = false;

        IsLoadingMore = false;
        StateHasChanged();
    }

    #region SEARCH
    string searchTerm = string.Empty;
    string SearchTerm
    {
        get => searchTerm;
        set
        {
            searchTerm = value;
            filter.SearchTerm = value;
            // Ne zovemo odmah, već ćemo koristiti debounce
            DebounceSearch();
        }
    }

    CancellationTokenSource? searchTokenSource;

    async void DebounceSearch()
    {
        searchTokenSource?.Cancel();
        searchTokenSource = new CancellationTokenSource();
        try
        {
            await Task.Delay(500, searchTokenSource.Token);
            if (!searchTokenSource.Token.IsCancellationRequested) await ResetAndReload();
        }
        catch (TaskCanceledException)
        {
            // Ignoriraj ako je otkazano
        }
    }

    void OnSearchInput(ChangeEventArgs e) => SearchTerm = e.Value?.ToString() ?? "";

    async Task ClearSearch()
    {
        SearchTerm = string.Empty;
        await ResetAndReload();
    }
    #endregion


    // Filter methods
    async Task ApplyFilters()
    {
        ShowMobileFilters = false;
        await ResetAndReload();
    }

    async Task ResetFilters()
    {
        filter = new MovieFilter();
        SearchTerm = string.Empty;
        ShowMobileFilters = false;
        await ResetAndReload();
    }

    async Task ResetAndReload()
    {
        CurrentPage = 0;
        Entities.Clear();
        HasMoreData = true;
        await LoadInitialData();
    }

    void SetLetterFilter(string? letter) => filter.Letter = letter;

    // For genre toggling with button
    void ToggleGenre(string genre)
    {
        filter.Genres ??= new List<string>();

        if (filter.Genres.Contains(genre)) filter.Genres.Remove(genre);
        else filter.Genres.Add(genre);
    }

    // For genre toggling with checkbox
    void ToggleGenre(string genre, object? isChecked)
    {
        filter.Genres ??= new List<string>();
        var checkedValue = isChecked as bool? == true;

        if (checkedValue && !filter.Genres.Contains(genre)) filter.Genres.Add(genre);
        else if (!checkedValue && filter.Genres.Contains(genre)) filter.Genres.Remove(genre);
    }

    void ToggleResolution(string resolution)
    {
        filter.Resolutions ??= new List<string>();

        if (filter.Resolutions.Contains(resolution)) filter.Resolutions.Remove(resolution);
        else filter.Resolutions.Add(resolution);
    }

    void ClearYearFilter()
    {
        filter.YearFrom = null;
        filter.YearTo = null;
    }

    void ToggleMobileFilters() => ShowMobileFilters = !ShowMobileFilters;

    void ToggleViewMode() => IsGridView = !IsGridView;

    // Properties for two-way binding
    string YearFrom
    {
        get => filter.YearFrom?.ToString() ?? string.Empty;
        set => filter.YearFrom = int.TryParse(value, out var year) ? year : null;
    }

    string YearTo
    {
        get => filter.YearTo?.ToString() ?? string.Empty;
        set => filter.YearTo = int.TryParse(value, out var year) ? year : null;
    }

    string SortBy
    {
        get => filter.SortBy + (filter.SortDescending ? "_desc" : string.Empty);
        set
        {
            if (value.EndsWith("_desc"))
            {
                filter.SortBy = value.Replace("_desc", string.Empty);
                filter.SortDescending = true;
            }
            else
            {
                filter.SortBy = value;
                filter.SortDescending = false;
            }
        }
    }

    [JSInvokable]
    public async Task LoadMoreJS() => await LoadMoreData();

    public void Dispose() => DotNetHelper?.Dispose();
}