@page "/vremeplov"
@layout VremeplovLayout

@inject IDbContextFactory<ApplicationDbContext> contextFactory
@inject IJSRuntime JS

<PageTitle>Požeški Vremeplov</PageTitle>

<div class="vremeplov-page">
    <div class="bg-noise"></div>
    <div class="bg-blob blob-gold"></div>
    <div class="bg-blob blob-blue"></div>

    <div class="container py-5 position-relative" style="z-index: 1;">
        <div class="row align-items-center mb-5 pt-4 position-relative">

            <!-- RUDINSKA GLAVA -->
            <div class="rudina-bg-wrapper">
                <img src="@CurrentHeadUrl" class="rudina-big-head" alt="Rudinska glava" />
            </div>

            <div class="ms-4 text-center text-lg-start mx-auto" style="z-index: 2;">

                <!-- Title & Author -->
                <div class="ps-3 d-inline-block border-start border-warning border-3">
                    <span class="text-uppercase text-warning small fw-bold" style="letter-spacing: 3px;">Požeški Vremeplov</span>
                    <span class="mt-1 d-block text-muted small" style="font-family: var(--kw-v-font-title);">autor: Tomislav Wittenberg</span>
                </div>

                <h1 class="mt-3 font-display fw-bold display-2 lh-1">
                    <span class="d-block text-gradient-gold">@SelectedDate.Day.</span>
                    <span class="d-block" style="color: var(--kw-v-primary);">@GetMonthName(SelectedDate.Month)</span>
                </h1>

                <!-- NAVIGACIJA (buttons) -->
                <div class="mt-4 d-inline-flex gap-2 p-1 rounded-pill nav-container">
                    <button class="btn btn-nav d-flex align-items-center gap-2" @onclick="() => ChangeDate(-1)"><span class="material-symbols-outlined fs-6">arrow_back</span> Jučer</button>
                    <button class="btn btn-nav @(IsToday ? "btn-nav-active" : "") d-flex align-items-center gap-2" @onclick="GoToToday">Danas</button>
                    <button class="btn btn-nav d-flex align-items-center gap-2" @onclick="() => ChangeDate(1)">Sutra <span class="material-symbols-outlined fs-6">arrow_forward</span></button>
                </div>
            </div>
        </div>

        <!-- LOADING STATE -->
        @if (Events is null)
        {
            <_Loading />
        }
        else
        {
            <div class="row g-4">
                @foreach (var item in Events)
                {
                    <div id="card-@item.Id" class="col-md-6 col-lg-4">
                        <_ChronicleCard Item="item" Share="true" OnShare="ShareCard" />
                    </div>
                }
            </div>
        }
        <_Footer />
    </div>
</div>



@code {
    List<Chronicle>? Events;

    DateTime SelectedDate;
    bool IsToday => SelectedDate.Date == DateTime.Now.Date;
    string CurrentHeadUrl = string.Empty;


    protected override async Task OnInitializedAsync()
    {
        var croatiaZone = TimeZoneInfo.FindSystemTimeZoneById("Central European Standard Time");
        SelectedDate = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, croatiaZone).Date;
        await LoadAsync();
    }

    async Task LoadAsync()
    {
        int headNumber = Random.Shared.Next(1, 19);
        CurrentHeadUrl = $"/img/heads/{headNumber:00}.png";

        await using var db = await contextFactory.CreateDbContextAsync();
        Events = await db.Chronicles.AsNoTracking()
                                   .Where(x => x.Day == SelectedDate.Day && x.Month == SelectedDate.Month)
                                   .OrderBy(x => x.Year) // Sortiraj po godini
                                   .ToListAsync();
    }

    async Task ShareCard(Chronicle item)
    {
        await using var jsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./Pages/Chronicles/Vremeplov.razor.js");

        await jsModule.InvokeVoidAsync("copyCardToClipboard", $"card-{item.Id}");
    }

    async Task ChangeDate(int days)
    {
        SelectedDate = SelectedDate.AddDays(days);
        await LoadAsync();
    }

    async Task GoToToday()
    {
        var croatiaZone = TimeZoneInfo.FindSystemTimeZoneById("Central European Standard Time");
        SelectedDate = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, croatiaZone).Date;
        await LoadAsync();
    }

    string GetMonthName(int month) => month switch
    {
        1 => "Siječnja",
        2 => "Veljače",
        3 => "Ožujka",
        4 => "Travnja",
        5 => "Svibnja",
        6 => "Lipnja",
        7 => "Srpnja",
        8 => "Kolovoza",
        9 => "Rujna",
        10 => "Listopada",
        11 => "Studenoga",
        12 => "Prosinca",
        _ => ""
    };
}