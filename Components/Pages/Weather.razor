@page "/weather/{city}"
@inject OpenWeatherClient OpenWeatherClient
@inject IJSRuntime JS
@implements IAsyncDisposable

<h3 class="mt-3 text-center">Weather in @City</h3>

@if (OpenWeather is null)
{
    <p class="text-center text-muted mt-5">Loading weather data for <b>@City</b>...</p>
}
else
{
    <div class="container mt-4">
        <div class="shadow p-4 ">
            <div class="mb-3">
                <strong>Temperature:</strong> @OpenWeather.Main.Temp °C<br />
                <strong>Humidity:</strong> @OpenWeather.Main.Humidity %<br />
                <strong>Conditions:</strong> @string.Join(", ", OpenWeather.Weather.Select(w => w.Description))
            </div>

            <hr />

            <div class="d-flex justify-content-center align-items-center">
                <div @key="City" class="chart-container" style="height: 100px; position: relative;">
                    <canvas id="tempChart"></canvas>
                </div>

                <div @key="City" class="chart-container mt-4" style="height: 100px; position: relative;">
                    <canvas id="humidityChart"></canvas>
                </div>

                <div @key="City" class="chart-container mt-4" style="height: 100px; position: relative;">
                    <canvas id="pressureChart"></canvas>
                </div>

                <div @key="City" class="chart-container mt-4" style="height: 100px; position: relative;">
                    <canvas id="windChart"></canvas>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string City { get; set; } = "Požega";
    OpenWeatherModel? OpenWeather;
    private IJSObjectReference? _jsModule;
    private bool _chartsRendered = false;
    private bool _disposed = false;

    protected override async Task OnParametersSetAsync()
    {
        // Reset flag kada se grad promijeni
        if (OpenWeather == null || !_chartsRendered)
        {
            OpenWeather = await OpenWeatherClient.GetWeatherAsync(City);
            _chartsRendered = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Samo jednom kreiraj chartove
        if (OpenWeather != null && !_chartsRendered && !_disposed)
        {
            // Sačekajte malo da se DOM stabilizira
            await Task.Delay(100);

            _jsModule ??= await JS.InvokeAsync<IJSObjectReference>(
                "import", "./Components/Pages/Weather.razor.js");

            await _jsModule.InvokeVoidAsync("renderWeatherCharts", new
            {
                temp = OpenWeather.Main.Temp,
                humidity = OpenWeather.Main.Humidity,
                pressure = OpenWeather.Main.Pressure,
                wind = OpenWeather.Wind.Speed
            });

            _chartsRendered = true;
            StateHasChanged(); // Osiguraj da se UI ažurira
        }
    }

    // Spriječi nepotrebno renderovanje
    protected override bool ShouldRender()
    {
        // Renderuj samo prvi put ili kada se grad promijeni
        return !_chartsRendered || OpenWeather == null;
    }

    // Čišćenje prije unmount-a
    public async ValueTask DisposeAsync()
    {
        if (!_disposed)
        {
            _disposed = true;

            if (_jsModule != null)
            {
                try
                {
                    await _jsModule.InvokeVoidAsync("disposeCharts");
                    await _jsModule.DisposeAsync();
                }
                catch (JSDisconnectedException)
                {
                    // Aplikacija se već odspojila, nije problem
                }
            }
        }
    }
}